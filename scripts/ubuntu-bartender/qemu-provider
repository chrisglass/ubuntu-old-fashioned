# Beginning of "public" methods used by ubuntu-bartender

function build-provider-assert-ready {
  if ! command -v qemu-system-${QEMU_ARCH} &>/dev/null
  then
    echo "error: qemu-system-${QEMU_ARCH} was not found in PATH" >&2
    exit 255
  fi

  if ! command -v cloud-localds &>/dev/null; then
    echo "error: cloud-image-utils not found. You can install it with:"
    echo "sudo apt install -y cloud-image-utils"
    exit 255
  fi

  _set_disk_size

  if [ -n "$QEMU_IMAGE" ]; then
    if [ ! -f "$QEMU_IMAGE" ]; then
      echo "error: specified image not found at $QEMU_IMAGE"
      exit 255
    fi
    virtual_size=$(qemu-img info --output=json "$QEMU_IMAGE" | jq '."virtual-size"')
    if [ "$virtual_size" -lt "$QEMU_IMAG_SIZE" ]; then
      echo "error: qemu disk is too small, it should be at least $(echo $QEMU_IMAG_SIZE | numfmt --to=iec-i) large"
      echo "Use 'qemu-img resize' to resize your disk"
      exit 255
    fi
  fi
}

function build-provider-destroy {
  kill "$(cat "$temp_dir/qemu.pid")" &> /dev/null
}

function build-provider-create {
  image="$temp_dir/bionic-server-cloudimg.img"
  user_data="$temp_dir/user_data.yaml"

  key_dir="$temp_dir/keys"
  echo "Generating SSH key in $key_dir"
  mkdir "$key_dir"
  ssh-keygen -t rsa -f "$temp_dir/keys/ubuntu" -P '' &> /dev/null

  QEMU_EXTRA_OPTIONS="-smp $QEMU_CPU -m $CAP_MEM"

  IMG_ARCH="${QEMU_ARCH}"
  case "${QEMU_ARCH}" in
    x86_64)
      IMG_ARCH='amd64'
      ;;
    ppc64le)
      IMG_ARCH='ppc64el'
      ;;
    aarch64)
      IMG_ARCH='arm64'
      # there is no default machine for arm64
      QEMU_EXTRA_OPTIONS="$QEMU_EXTRA_OPTIONS -machine virt -cpu max"
      # arm only supports uEFI boot
      QEMU_EXTRA_OPTIONS="$QEMU_EXTRA_OPTIONS -bios /usr/share/qemu-efi-aarch64/QEMU_EFI.fd"
      ;;
esac

  if [ "${QEMU_ARCH}" = "$(uname -p)" ] && lsmod | grep -q '^kvm '; then
    QEMU_EXTRA_OPTIONS="$QEMU_EXTRA_OPTIONS -enable-kvm"
  fi

  if [ -z "$QEMU_IMAGE" ]; then
    if ! wget -qO "$image" http://cloud-images.ubuntu.com/bionic/current/bionic-server-cloudimg-$IMG_ARCH.img; then
      echo "error: could not find the bionic image for $IMG_ARCH on cloud-images.ubuntu.com"
      cleanup
      exit 255
    fi

    qemu-img resize "$image" "$QEMU_IMG_SIZE" &> /dev/null
  else
    image="$QEMU_IMAGE"
  fi

  cat << EOF > "$user_data"
#cloud-config

ssh_authorized_keys:
 - $(cat "$temp_dir/keys/ubuntu.pub")
EOF

  cloud-localds "$temp_dir/seed.img" "$user_data"

  ssh_port=$(_get_ssh_port)
  qemu-system-${QEMU_ARCH} \
    $QEMU_EXTRA_OPTIONS \
    -pidfile "$temp_dir/qemu.pid" \
    -nographic \
    -snapshot \
    -drive if=virtio,format=qcow2,file="${image}" \
    -nic user,model=virtio,hostfwd="tcp::${ssh_port}-:22" \
    -drive if=virtio,format=raw,file="$temp_dir/seed.img" &> "$temp_dir/qemu.log" </dev/null &

  sleep 5
  echo "QEMU instance started, waiting for boot"
  _wait-instance-connectable
}

function build-provider-upload {
  scp $(set-key-opt) -P ${ssh_port} -qo StrictHostKeyChecking=no "$2" "ubuntu@0.0.0.0:$3"
}

function build-provider-download {
  scp $(set-key-opt) -P ${ssh_port} -qo StrictHostKeyChecking=no "ubuntu@0.0.0.0:$2" "$3"
}

function build-provider-run {
  args=$(echo -- $@ | sed 's/.*--//')
  ssh $(set-key-opt) -p ${ssh_port} -qo StrictHostKeyChecking=no "ubuntu@0.0.0.0" -- $args
}

# Beginning of "private" helpers used by the previous methods

function _wait-instance-connectable {
  for attempt in $(seq 12); do
    if ! ssh $(set-key-opt) -p ${ssh_port} -qo StrictHostKeyChecking=no "ubuntu@0.0.0.0" -- true; then
      if ! ps "$(cat "$temp_dir/qemu.pid")" &> /dev/null; then
        echo "error: QEMU failed."
        cat "$temp_dir/qemu.log"
        exit 255
      fi
      sleep 10
    else
      state=connectable
      break
    fi
  done

  if [ "$state" != "connectable" ]; then
    echo "error: instance not 'connectable' after 2 minutes"
    exit 255
  fi
}

# _set_disk_size compute the disk space to use and store it in QEMU_IMG_SIZE
function _set_disk_size {
  available=$(df --output=avail "$TEMP_DIR_LOC" | tail -n1)
  if [ "$available" -lt 25000000 ]; then
    echo "Low space detected on drive ($(echo $available | numfmt --to=iec-i)). please consider using a cloud provider like Azure or AWS"
    exit 1
  elif [ "$available" -lt 60000000 ]; then
    echo "less than optimal space found. Be aware that on large builds, this may reach capacity."
    QEMU_IMG_SIZE="$(( 1000*available/2 ))"
    return
  fi

  QEMU_IMG_SIZE='30000000000'
}

# _get_ssh_port returns the first un-used TCP port between 2222 and 2300
function _get_ssh_port {
  port=2222
  while [ "$port" -lt 2300 ]; do
    if [ -z "$(ss -Hnlt "( sport = :$port )")" ]; then
      echo "$port"
      return
    fi
    port=$(( port+1 ))
  done

  echo "error: no port available for SSH in 2222-2300"
  echo "There is an issue with your system"
  exit 1
}

function set-key-opt {
  export KEY_OPT=''
  if [ -f "$temp_dir/keys/ubuntu" ]; then
    KEY_OPT="-i $temp_dir/keys/ubuntu"
  fi

  echo ${KEY_OPT}
}
